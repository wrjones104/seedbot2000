{% extends "base.html" %}

{% block title %}My Profile{% endblock %}

{% block content %}
    <div class="grid mb-1">
        <h1 style="margin-bottom: 0;">My Profile</h1>
        <div style="text-align: right;">
            <a href="{% url 'preset-create' %}" role="button">Create a New Preset</a>
        </div>
    </div>

    <article>
        <div class="grid">
            <article>
                <h3 class="stat-header">Total Seeds Rolled</h3>
                <p class="stat-number">{{ total_rolls }}</p>
            </article>
            <article>
                <h3 class="stat-header">Favorite Preset</h3>
                <p class="stat-number">
                    {% if favorite_preset != "N/A" %}
                        {{ favorite_preset.seed_type }}
                        <small>({{ favorite_preset.roll_count }} rolls)</small>
                    {% else %}
                        No seeds rolled yet
                    {% endif %}
                </p>
            </article>
        </div>
    </article>

    <article>
        <header>
            <h2>Recently Rolled Seeds</h2>
        </header>
        {% if recent_rolls %}
            <table>
                <thead>
                    <tr>
                        <th>Preset</th>
                        <th>Time</th>
                        <th>Link</th>
                    </tr>
                </thead>
                <tbody>
                    {% for roll in recent_rolls %}
                    <tr>
                        <td>{{ roll.seed_type }}</td>
                        <td>{{ roll.timestamp }}</td>
                        <td>
                            {% if roll.share_url %}
                                {% if roll.share_url|slice:":7" == '/media/' %}
                                    <a href="{{ roll.share_url }}" download>Download</a>
                                {% else %}
                                    <a href="{{ roll.share_url }}" target="_blank">Download</a>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>You haven't rolled any seeds yet.</p>
        {% endif %}
    </article>
    
    <hr>

    <h2 id="favorite-header" {% if not favorite_presets_list %}style="display: none;"{% endif %}>My Favorited Presets</h2>
    <div class="card-grid" id="favorite-grid">
        {% if favorite_presets_list %}
            {% for preset in favorite_presets_list %}
                {% include "webapp/_preset_card.html" %}
            {% endfor %}
        {% else %}
        {% endif %}
    </div>
    <hr {% if not favorite_presets_list %}style="display: none;"{% endif %}>

    <h2>My Created Presets</h2>
    <div class="card-grid" id="regular-grid">
        {% if user_presets %}
            {% for preset in user_presets %}
                {% include "webapp/_preset_card.html" %}
            {% endfor %}
        {% else %}
        {% endif %}
    </div>
    {% include "webapp/_yaml_modal.html" %}

    <hr>

    <h2>API Keys</h2>
    <p>Use these keys to access the <a href="https://github.com/wrjones104/seedbot2000/blob/master/API_USAGE.md" target="_blank">SeedBot API</a>.</p>

    {% if api_keys %}
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Key</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for key in api_keys %}
                <tr>
                    <td>{{ key.name }}</td>
                    <td><code>{{ key.key }}</code></td>
                    <td>{{ key.created_at }}</td>
                    <td>
                        <form action="{% url 'api-key-delete' key.id %}" method="post" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="outline contrast" onclick="return confirm('Are you sure?');">Revoke</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No API keys generated.</p>
    {% endif %}

    <form action="{% url 'api-key-create' %}" method="post">
        {% csrf_token %}
        <div class="grid">
            <input type="text" name="name" placeholder="Key Name (e.g. My Script)" required>
            <button type="submit">Generate New Key</button>
        </div>
    </form>

{% endblock %}
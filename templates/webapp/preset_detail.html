{% extends "base.html" %}

{% block title %}{{ preset.preset_name }}{% endblock %}

{% block content %}
<article>
    <header>
        <h2>{{ preset.preset_name }}</h2>
        <p>Created by: {{ preset.creator_name }}</p>
    </header>

    <dl>
        <dt>Validation Status</dt>
        <dd>
            {% if preset.validation_status == 'VALID' %}
                <strong style="color: var(--pico-color-green-500);">✔️ Valid</strong>
            {% elif preset.validation_status == 'PENDING' %}
                <strong style="color: var(--pico-color-orange-500);">⌛ Pending Validation...</strong>
            {% elif preset.validation_status == 'INVALID' %}
                <strong style="color: var(--pico-color-red-500);">❌ Invalid</strong>
            {% endif %}
        </dd>

        {% if preset.validation_status == 'INVALID' %}
        <dt>Error Details</dt>
        <dd>
            <pre><code>{{ preset.validation_error|default:"No specific error message was recorded." }}</code></pre>
        </dd>
        {% endif %}

        <dt>Description</dt>
        <dd>{{ preset.description|default:"No description provided." }}</dd>

        <dt>Flags</dt>
        <dd>
            {% if preset.hidden %}
            <em>Flags are hidden for this preset.</em>
            {% else %}
            <pre><code>{{ preset.flags|default:"None" }}</code></pre>
            {% endif %}
        </dd>

        <dt>Arguments</dt>
        <dd>{{ preset.arguments|default:"None" }}</dd>

        <dt>Times Generated</dt>
        <dd>{{ preset.gen_count }}</dd>
    </dl>

    <footer>
        <div class="button-group">
            <button 
                type="button" 
                class="btn-blue js-roll-seed-dispatcher" 
                data-url="{% url 'roll-seed' preset.pk %}"
                data-status-url-base="{% url 'get-local-seed-roll-status' 'TASK_ID_PLACEHOLDER' %}"
                {% if preset.validation_status != 'VALID' %}
                    disabled 
                    aria-label="This preset must be valid to be rolled" 
                    data-tooltip="This preset must be valid to be rolled"
                {% endif %}
            >
            {% if preset.validation_status == 'PENDING' %}
                Validating...
            {% elif preset.validation_status == 'INVALID' %}
                Cannot Roll
            {% else %}
                Roll Seed
            {% endif %}
            </button>

            {% if is_owner %}
            <a href="{% url 'preset-update' preset.pk %}" role="button" class="btn-orange">Edit</a>
            <a href="{% url 'preset-delete' preset.pk %}" role="button" class="btn-red">Delete</a>
            {% endif %}
        </div>
    </footer>
</article>

<a href="{{ request.META.HTTP_REFERER|default:'/' }}">← Back</a>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const presetStatus = "{{ preset.validation_status }}";
        if (presetStatus === 'PENDING') {
            const statusUrl = "{% url 'preset-status' preset.pk %}";
            const interval = setInterval(() => {
                fetch(statusUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status !== 'PENDING') {
                            clearInterval(interval);
                            window.location.reload();
                        }
                    })
                    .catch(error => {
                        console.error('Error polling preset status:', error);
                        clearInterval(interval);
                    });
            }, 5000); // Check every 5 seconds
        }
    });
</script>
{% endblock %}
{% extends "base.html" %}
{% load static %}

{% block title %}Tune Up{% endblock %}

{% block content %}
<div style="text-align: center; max-width: 800px; margin: 2rem auto;">
    <header style="margin-bottom: 2rem;">
        <h2>Tune Up</h2>
        <p>Apply or remove music randomization from an existing seed ROM.</p>
    </header>

    {% if error %}
    <article style="background-color: var(--pico-muted-border-color); border-color: var(--pico-muted-border-color); color: var(--pico-contrast);">
        <p>{{ error }}</p>
    </article>
    {% endif %}

    <form id="tune-up-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-group">
            {{ form.rom_file.label_tag }}
            {{ form.rom_file }}
            {% if form.rom_file.help_text %}
            <small>{{ form.rom_file.help_text }}</small>
            {% endif %}
        </div>

        <div class="grid">
            <article>
                <hgroup>
                    <h5>Standard</h5>
                    <p>The standard music randomization. A balanced mix of tracks.</p>
                </hgroup>
                <button type="button" class="contrast js-tune-up-dispatcher" data-tunes-type="tunes">Standard</button>
            </article>
            <article>
                <hgroup>
                    <h5>Chaotic</h5>
                    <p>A more chaotic music randomization. Expect the unexpected!</p>
                </hgroup>
                <button type="button" class="contrast js-tune-up-dispatcher" data-tunes-type="ctunes">Chaotic</button>
            </article>
            <article>
                <hgroup>
                    <h5>Silence</h5>
                    <p>No music will be played. For those who prefer the sound of silence.</p>
                </hgroup>
                <button type="button" class="contrast js-tune-up-dispatcher" data-tunes-type="notunes">Silence</button>
            </article>
            <article>
                <hgroup>
                    <h5>De-Tune</h5>
                    <p>Restore original music to a seed that has had music randomization applied.</p>
                </hgroup>
                <button type="button" class="contrast js-detune-dispatcher">De-Tune</button>
            </article>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    const TUNE_UP_DISPATCHER_URL = "{% url 'tune-up-api' %}";
    const TUNE_UP_STATUS_URL_BASE = "{% url 'tune-up-status' task_id='TASK_ID_PLACEHOLDER' %}";
    const DETUNE_DISPATCHER_URL = "{% url 'detune-api' %}";
    const DETUNE_STATUS_URL_BASE = "{% url 'detune-status' task_id='TASK_ID_PLACEHOLDER' %}";

    jQuery(document).ready(function($) {
        // Handler for all Tune Up buttons
        $(document).on('click', '.js-tune-up-dispatcher', function() {
            const button = $(this);
            const fileInput = $('#id_rom_file')[0];
            const tunesType = button.data('tunes-type');

            if (!fileInput.files.length) {
                alert('Please select a ROM file to tune up.');
                return;
            }

            const formData = new FormData();
            formData.append('rom_file', fileInput.files[0]);
            formData.append('tunes_type', tunesType);
            formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val()); // <-- ADD THIS LINE

            initiateTaskAndPoll({
                dispatcherUrl: TUNE_UP_DISPATCHER_URL,
                statusUrlBase: TUNE_UP_STATUS_URL_BASE,
                formData: formData,
                modalTitle: "Applying Tunes...",
                modalMessage: "Please wait while we apply music randomization."
            });
        });

        // Handler for the new De-Tune button
        $(document).on('click', '.js-detune-dispatcher', function() {
            const button = $(this);
            const fileInput = $('#id_rom_file')[0];

            if (!fileInput.files.length) {
                alert('Please select a ROM file to de-tune.');
                return;
            }

            const formData = new FormData();
            formData.append('rom_file', fileInput.files[0]);
            formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val());

            initiateTaskAndPoll({
                dispatcherUrl: DETUNE_DISPATCHER_URL,
                statusUrlBase: DETUNE_STATUS_URL_BASE,
                formData: formData,
                modalTitle: "Restoring Music...",
                modalMessage: "Please wait while we restore the original music."
            });
        });
    });
</script>
{% endblock %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SeedBot{% endblock %}</title>

    {% if GOOGLE_TAG_MANAGER_ID %}
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','{{ GOOGLE_TAG_MANAGER_ID }}');</script>
    {% endif %}
    
    <link rel="icon" type="image/png" href="{% static 'images/seedbot_new.png' %}">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
    <style>
        /* --- FIX: New style for the favorite button to match other icons --- */
        .js-favorite-btn {
            border: none !important;
            background: transparent !important;
            opacity: 0.5;
            transition: all 0.2s ease-in-out;
            color: var(--pico-color); /* Use default text color */
        }
        .js-favorite-btn.favorited,
        .js-favorite-btn:hover {
            opacity: 1;
            color: #f5b700; /* Gold/yellow color */
        }
        .p-larger {
            font-size: 1.1rem;
            color: var(--pico-secondary);
        }
    </style>
</head>
<body>
    {% if GOOGLE_TAG_MANAGER_ID %}
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id={{ GOOGLE_TAG_MANAGER_ID }}"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    {% endif %}
    <nav class="container">
        <ul>
            <li>
                <a href="{% url 'home' %}" class="secondary">
                    <img src="{% static 'images/seedbot_new.png' %}" alt="SeedBot" style="height: 32px; vertical-align: middle; margin-right: 10px;">
                    <strong>SeedBot</strong>
                </a>
            </li>
        </ul>
        <ul>
            <li><a href="{% url 'quick-roll' %}">Quick Roll</a></li>
            <li><a href="{% url 'tune-up' %}">Tune Up</li>
            <li><a href="{% url 'preset-list' %}">All Presets</a></li>
            {% if user.is_authenticated %}
                <li><a href="{% url 'my-profile' %}">My Profile</a></li>
                <li><a href="#" role="button" onclick="openModal('logout-modal')">Logout</a></li>
            {% else %}
                <li><a href="{% url 'account_login' %}" role="button">Login</a></li>
            {% endif %}
        </ul>
    </nav>

    <main class="container">
        {% csrf_token %}
        {% block content %}
        {% endblock %}
    </main>

    <footer class="container">
        <hr>
        <div class="grid">
            <div>
                <h4 class="text-muted">SeedBot</h4>
                <ul class="no-bullets">
                    <li><a href="https://github.com/wrjones104/seedbot2000">GitHub Repository</a></li>
                    <li><a href="https://discord.com/oauth2/authorize?client_id=892560638969278484&permissions=1494917180496&scope=bot">Invite the Bot</a></li>
                    <li><a href="https://github.com/wrjones104/seedbot2000/issues">Report an Issue</a></li>
                </ul>
            </div>
            <div>
                <h4 class="text-muted">FFVI: Worlds Collide</h4>
                <ul>
                    <li><a href="https://ff6worldscollide.com">Main Website</a></li>
                    <li><a href="https://wiki.ff6worldscollide.com/wiki/Main_Page">Documentation</a></li>
                    <li><a href="https://discord.gg/5MPeng5">Community Discord</a></li>
                </ul>
            </div>
            <div>
                <h4 class="text-muted">Archipelago</h4>
                <ul>
                    <li><a href="https://archipelago.gg">Main Website</a></li>
                    <li><a href="https://github.com/ArchipelagoMW/Archipelago">Documentation</a></li>
                    <li><a href="https://discord.gg/8Z65BR2">Community Discord</a></li>
                </ul>
            </div>
        </div>
        <small>
            SeedBot is a fan-made front-end for the FFVI: Worlds Collide randomizer and is not affiliated with or endorsed by Square Enix.
            <br>
            Â© {% now "Y" %} The SeedBot Project.
        </small>
    </footer>
    <dialog id="logout-modal">
        <article style="text-align: center;">
            <header>
                <button aria-label="Close" rel="prev" onclick="closeModal('logout-modal')"></button>
                <img src="{% static 'images/seedbot_new.png' %}" alt="SeedBot" style="height: 64px;">
            </header>
            <p>
                <strong>Are you sure you want to log out?</strong>
            </p>
            <footer class="button-group">
                <form>
                    <button type="button" class="secondary" onclick="closeModal('logout-modal')">Cancel</button>
                </form>
                <form method="post" action="{% url 'account_logout' %}">
                    {% csrf_token %}
                    <button type="submit" class="contrast">Log Out</button>
                </form>
            </footer>
        </article>
    </dialog>

    <dialog id="seed-roll-modal">
        <article style="text-align: center;">
            <header>
                <button aria-label="Close" rel="prev" onclick="closeModal('seed-roll-modal')"></button>
                <h3 id="seed-roll-modal-header">Rolling Seed...</h3>
            </header>
            <div id="seed-roll-modal-content">
                <img src="{% static 'images/seedbot_new.png' %}" alt="SeedBot" style="height: 64px;">
                <p>Please wait while we generate your seed.</p>
                <progress indeterminate></progress>
            </div>
            <footer style="display: none;" id="seed-roll-modal-footer">
                <button class="secondary" onclick="closeModal('seed-roll-modal')">Close</button>
            </footer>
        </article>
    </dialog>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="{% static 'js/pico.min.js' %}"></script>

    <script>
        const SILLY_THINGS = {{ silly_things_json|default:'[]'|safe }};
        function openModal(modalId) {
            document.getElementById(modalId)?.showModal();
        }
        function closeModal(modalId) {
            document.getElementById(modalId)?.close();
        }

        function pollTaskStatus(statusUrl) {
            const modal = document.getElementById('seed-roll-modal');
            const header = document.getElementById('seed-roll-modal-header');
            const content = document.getElementById('seed-roll-modal-content');
            const footer = document.getElementById('seed-roll-modal-footer');

            const interval = setInterval(() => {
                fetch(statusUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'SUCCESS') {
                            clearInterval(interval);
                            header.innerText = 'Seed Generated!';
                            
                            // Handle both local files and external URLs
                            if (data.result.startsWith('http')) {
                                content.innerHTML = `<p>Your seed is ready!</p><h4><a href="${data.result}" target="_blank">Open Seed Page</a></h4>`;
                                window.open(data.result, '_blank');
                            } else {
                                content.innerHTML = `<p>Your seed is ready! It will download automatically.</p><h4><a href="${data.result}" download>Download Seed File</a></h4>`;
                                window.location.href = data.result;
                            }
                            footer.style.display = 'block';
                            
                        } else if (data.status === 'FAILURE') {
                            clearInterval(interval);
                            header.innerText = 'An Error Occurred';
                            content.innerHTML = `<p>Could not generate seed.</p><p><small>${data.result || 'Unknown error.'}</small></p>`;
                            footer.style.display = 'block';
                        } else if (data.status === 'PROGRESS') {
                            header.innerText = data.result || 'Processing...';
                        }
                    })
                    .catch(error => {
                        clearInterval(interval);
                        console.error('Error polling task status:', error);
                        header.innerText = 'An Error Occurred';
                        content.innerHTML = `<p>A network error occurred while trying to check the seed status.</p>`;
                        footer.style.display = 'block';
                    });
            }, 3000);
        }

        function checkFeaturedVisibility() {
            const featuredHeader = $('#featured-header');
            if ($('#featured-grid').children('article').length > 0) {
                featuredHeader.show().next('hr').show();
            } else {
                featuredHeader.hide().next('hr').hide();
            }
        }

        function checkFavoriteVisibility() {
            const favoriteHeader = $('#favorite-header');
            const grid = $('#favorite-grid');
            if (grid.children('article').length > 0) {
                favoriteHeader.show().next('hr').show();
            } else {
                favoriteHeader.hide().next('hr').hide();
            }
        }

        function checkVisibility(gridId, headerId) {
            const header = $(`#${headerId}`);
            const grid = $(`#${gridId}`);
            if (grid.length && grid.children('article').length > 0) {
                header.show().next('hr').show();
            } else {
                header.hide().next('hr').hide();
            }
        }

        function initiateTaskAndPoll(options) {
            const {
                dispatcherUrl,
                statusUrlBase,
                formData,
                modalTitle,
                modalMessage,
            } = options;

            const modal = document.getElementById('seed-roll-modal');
            const header = document.getElementById('seed-roll-modal-header');
            const content = document.getElementById('seed-roll-modal-content');
            const footer = document.getElementById('seed-roll-modal-footer');

            header.innerText = modalTitle;
            content.innerHTML = `<img src="{% static 'images/seedbot_new.png' %}" alt="SeedBot" style="height: 64px;"><p><strong>${modalMessage}</strong></p><progress indeterminate></progress>`;
            footer.style.display = 'none';
            openModal('seed-roll-modal');

            const csrfToken = $('[name=csrfmiddlewaretoken]').val();
            const fetchOptions = {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
            };

            if (formData) {
                // For file uploads, FormData sets the Content-Type header automatically
                // so we remove our default headers.
                delete fetchOptions.headers;
                fetchOptions.body = formData;
            }

            fetch(dispatcherUrl, fetchOptions)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || 'A server error occurred.');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.task_id) {
                        const statusUrl = statusUrlBase.replace('TASK_ID_PLACEHOLDER', data.task_id);
                        pollTaskStatus(statusUrl);
                    } else if (data.error) {
                        header.innerText = 'An Error Occurred';
                        content.innerHTML = `<p>${data.error}</p>`;
                        footer.style.display = 'block';
                    }
                    // ... handle other cases like 'api' method if needed
                })
                .catch(error => {
                    header.innerText = 'An Error Occurred';
                    content.innerHTML = `<p>${error.message}</p>`;
                    footer.style.display = 'block';
                });
        }

        jQuery(document).ready(function($) {
            $('#id_arguments').select2({ placeholder: 'Select arguments', allowClear: true });

            $(document).on('click', '.js-roll-seed-dispatcher', function() {
                const button = $(this);
                const randomLine = SILLY_THINGS.length > 0 ? SILLY_THINGS[Math.floor(Math.random() * SILLY_THINGS.length)] : "Rolling your seed...";

                initiateTaskAndPoll({
                    dispatcherUrl: button.data('url'),
                    statusUrlBase: button.data('status-url-base'),
                    modalTitle: 'Rolling Seed...',
                    modalMessage: randomLine.charAt(0).toUpperCase() + randomLine.slice(1),
                });
            });

            $(document).on('click', '.js-feature-btn', function() {
                const button = $(this);
                const featureUrl = button.data('url');
                const card = button.closest('article');
                const cardPk = card.data('pk');
                const csrfToken = $('[name=csrfmiddlewaretoken]').val();

                fetch(featureUrl, { method: 'POST', headers: { 'X-CSRFToken': csrfToken }})
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Toggle 'featured' class on all copies of this card's pin button
                        $(`article[data-pk='${cardPk}'] .js-feature-btn`).toggleClass('featured', data.featured);

                        const isFavorited = card.closest('#favorite-grid').length > 0;
                        const featuredGrid = $('#featured-grid');
                        const regularGrid = $('#regular-grid');

                        if (data.featured) {
                            // Move a copy of the card to the featured grid
                            featuredGrid.prepend(card.clone().hide().fadeIn(200));
                            // If it's not a favorite, remove it from the regular grid
                            if (!isFavorited) {
                                regularGrid.find(`article[data-pk='${cardPk}']`).fadeOut(200, function() { $(this).remove(); });
                            }
                        } else {
                            // It was un-featured. Remove it from the featured grid.
                            featuredGrid.find(`article[data-pk='${cardPk}']`).fadeOut(200, function() { $(this).remove(); });
                            // If it's not a favorite, add it back to the regular grid
                            if (!isFavorited) {
                                regularGrid.prepend(card.clone().hide().fadeIn(200));
                            }
                        }
                        // Update visibility of the "Featured" header
                        checkVisibility('featured-grid', 'featured-header');
                    }
                });
            });

            $(document).on('click', '.js-favorite-btn', function() {
                const button = $(this);
                const favoriteUrl = button.data('url');
                const card = button.closest('article');
                const cardPk = card.data('pk');
                const csrfToken = $('[name=csrfmiddlewaretoken]').val();
                
                fetch(favoriteUrl, { method: 'POST', headers: { 'X-CSRFToken': csrfToken }})
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Toggle the 'favorited' class on all copies of this card
                        $(`article[data-pk='${cardPk}'] .js-favorite-btn`).toggleClass('favorited', data.favorited);

                        const isFeatured = card.closest('#featured-grid').length > 0 || $('#featured-grid').find(`article[data-pk='${cardPk}']`).length > 0;
                        const favoriteGrid = $('#favorite-grid');
                        
                        if (favoriteGrid.length) {
                            if (data.favorited) {
                                // Add a copy to the favorites grid
                                favoriteGrid.prepend(card.clone().hide().fadeIn(200));
                                // Remove the original from the regular grid if it's not also featured
                                if (!isFeatured) {
                                    $('#regular-grid').find(`article[data-pk='${cardPk}']`).fadeOut(200, function() { $(this).remove(); });
                                 }
                            } else {
                                // When un-favoriting, remove the copy from the favorites grid
                                favoriteGrid.find(`article[data-pk='${cardPk}']`).fadeOut(200, function() { $(this).remove(); });
                                // And add it back to the regular grid if it's not featured
                                if (!isFeatured) {
                                    $('#regular-grid').prepend(card.clone().hide().fadeIn(200));
                                }
                            }
                        checkVisibility('favorite-grid', 'favorite-header');
                        }
                    }
                });
            });

            checkVisibility('featured-grid', 'featured-header');
            checkVisibility('favorite-grid', 'favorite-header');
        });
    </script>
    {% block scripts %}
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const yamlModal = document.getElementById('yaml-modal');
        // Only run if the modal is on the current page
        if (!yamlModal) return;

        const yamlModalForm = document.getElementById('yaml-modal-form');
        const presetNameSpan = document.getElementById('yaml-modal-preset-name');
        
        // Add event listeners to all "Make .yaml" buttons
        document.querySelectorAll('.js-show-yaml-modal').forEach(button => {
            button.addEventListener('click', event => {
                const presetName = event.currentTarget.dataset.presetName;
                const formUrl = event.currentTarget.dataset.url;

                // Populate modal with preset-specific info
                presetNameSpan.textContent = presetName;
                yamlModalForm.action = formUrl;
                
                // Reset form to its default checked values
                yamlModalForm.reset();

                // Use the global openModal function from base.html
                openModal('yaml-modal');
            });
        });

        // Handle closing the modal after form submission
        yamlModalForm.addEventListener('submit', () => {
            // Use a short timeout to allow the request to be sent before closing
            setTimeout(() => closeModal('yaml-modal'), 300);
        });
    });
</script>{% endblock %}
</body>
</html>